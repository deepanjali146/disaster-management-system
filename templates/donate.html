{% extends "base.html" %}

{% block title %}Donate{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Donation Statistics -->
            {% if stats %}
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success">₹{{ "%.2f"|format(stats.total_amount or 0) }}</h3>
                            <p class="text-muted">Total Raised</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary">{{ stats.total_count or 0 }}</h3>
                            <p class="text-muted">Total Donations</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info">{{ stats.recent_donations|length or 0 }}</h3>
                            <p class="text-muted">Recent Donations</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="donation-form form-container">
                <h2 class="text-center mb-2">Make a Donation</h2>
                <p class="text-center text-muted">Your contribution helps provide essential resources to those affected by disasters.</p>
                
                <!-- UPI Payment Form -->
                {% if upi_qr %}
                <div class="upi-payment-container">
                    <div class="alert alert-info">
                        <h5><i class="fas fa-qrcode me-2"></i>UPI Payment QR Code</h5>
                        <p>Scan the QR code below with any UPI app (PhonePe, Google Pay, Paytm, etc.) to complete your donation:</p>
                    </div>
                    
                    <div class="text-center mb-4">
                        <img src="data:image/png;base64,{{ upi_qr.qr_code }}" alt="UPI Payment QR Code" class="img-fluid" style="max-width: 300px; border: 2px solid #ddd; border-radius: 10px;">
                    </div>
                    
                    <div class="payment-details">
                        <h6>Payment Details:</h6>
                        <p><strong>Amount:</strong> ₹{{ amount }}</p>
                        <p><strong>Donor:</strong> {{ donor_name }}</p>
                        <p><strong>Email:</strong> {{ donor_email }}</p>
                        <p><strong>Purpose:</strong> {{ upi_qr.purpose }}</p>
                        <p><strong>Payment Method:</strong> UPI Direct Transfer</p>
                    </div>
                    
                    <div class="mt-3">
                        <a href="{{ upi_qr.upi_url }}" class="btn btn-primary" target="_blank">
                            <i class="fas fa-mobile-alt me-2"></i>Open in UPI App
                        </a>
                        <span class="badge bg-success ms-2 align-middle"><i class="fas fa-check me-1"></i>No verification needed</span>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-info-circle me-2"></i>How to Pay:</h6>
                        <ol class="mb-0">
                            <li>Open any UPI app on your phone</li>
                            <li>Scan the QR code above</li>
                            <li>Enter the amount: ₹{{ amount }}</li>
                            <li>Complete the payment</li>
                            <li>Your donation is completed once payment succeeds in your UPI app</li>
                        </ol>
                    </div>
                </div>
                {% else %}
                <!-- Regular Donation Form -->
                <form method="POST" id="donationForm">
                    <div class="mb-3">
                        <label for="amount" class="form-label">Donation Amount (₹)</label>
                        <input type="number" class="form-control" id="amount" name="amount" min="1" step="1" placeholder="Enter amount" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="donor_name" class="form-label">Donor Name</label>
                        <input type="text" class="form-control" id="donor_name" name="donor_name" value="{{ session.user_name or '' }}" placeholder="Enter your name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="donor_email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="donor_email" name="donor_email" value="{{ session.user_email or '' }}" placeholder="Enter your email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="payment_method" class="form-label">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="" selected disabled>Select payment method</option>
                            <option value="upi">UPI Payment (QR Code)</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-heart me-2"></i>Donate Now
                    </button>
                </form>
                {% endif %}
                
                <div class="mt-4">
                    <h5><i class="fas fa-hands-helping me-2"></i>How your donation helps:</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-home text-primary me-2"></i>Provides emergency shelter</li>
                                <li><i class="fas fa-utensils text-success me-2"></i>Supplies food and clean water</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-medkit text-danger me-2"></i>Offers medical assistance</li>
                                <li><i class="fas fa-tools text-warning me-2"></i>Supports recovery efforts</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- UPI Payment Integration Script -->
<script>
// Handle payment method change
document.getElementById('payment_method')?.addEventListener('change', function() {
    const method = this.value;
    const form = document.getElementById('donationForm');
    
    if (method === 'upi') {
        // Show UPI info
        const existingAlert = form.querySelector('.upi-info-alert');
        if (!existingAlert) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info mt-3 upi-info-alert';
            alertDiv.innerHTML = '<i class="fas fa-qrcode me-2"></i>UPI QR code will be generated after form submission. Complete the payment in your UPI app and you are done. No verification step needed.';
            form.appendChild(alertDiv);
        }
    } else {
        // Remove UPI info
        const existingAlert = form.querySelector('.upi-info-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
    }
});
</script>
{% endblock %}