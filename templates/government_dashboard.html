{% extends "base.html" %}
{% block title %}Government Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-gradient mb-2">Government Dashboard</h1>
                    <p class="text-muted">Manage emergency requests, team assignments, and track progress</p>
                </div>
                <div>
                    <span class="badge bg-gradient-info fs-6 px-3 py-2">Government</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-stats-card">
                <div class="admin-stats-number">{{ total_requests or 0 }}</div>
                <div class="admin-stats-label">Total Requests</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-stats-card">
                <div class="admin-stats-number">{{ pending_requests or 0 }}</div>
                <div class="admin-stats-label">Pending Requests</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-stats-card">
                <div class="admin-stats-number">{{ active_assignments or 0 }}</div>
                <div class="admin-stats-label">Active Assignments</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="admin-stats-card">
                <div class="admin-stats-number">{{ completed_tasks or 0 }}</div>
                <div class="admin-stats-label">Completed Tasks</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Requests Section -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Emergency Requests from Admin (Pending)
                        <span class="badge bg-light text-dark ms-2">{{ pending_requests_list|length if pending_requests_list else 0 }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if pending_requests_list %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Request ID</th>
                                        <th>Incident Details</th>
                                        <th>Location</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Received</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in pending_requests_list %}
                                    <tr class="incident-card">
                                        <td><strong>#{{ request.id }}</strong></td>
                                        <td>
                                            <div>
                                                <strong>Incident #{{ request.incident_id }}</strong>
                                                {% if request.incidents %}
                                                <br><small class="text-muted">{{ request.incidents.description[:50] }}{% if request.incidents.description|length > 50 %}...{% endif %}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ request.incidents.location if request.incidents else 'N/A' }}</strong>
                                                {% if request.incidents and request.incidents.pincode %}
                                                <br><small class="text-muted">Pincode: {{ request.incidents.pincode }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            {% if request.incidents %}
                                            <span class="incident-severity severity-{{ request.incidents.severity|lower }}">
                                                {{ request.incidents.severity|title }}
                                            </span>
                                            {% else %}
                                            <span class="badge bg-secondary">Unknown</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if request.status == 'pending' %}warning{% elif request.status == 'accepted' %}primary{% elif request.status == 'notified' %}info{% elif request.status == 'assigned' %}success{% elif request.status == 'completed' %}secondary{% else %}secondary{% endif %} fs-6">
                                                {{ request.status|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ request.created_at[:10] if request.created_at else 'Recently' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                {% if request.status == 'pending' %}
                                                <form method="POST" action="{{ url_for('notify_emergency_head') }}" class="d-inline">
                                                    <input type="hidden" name="request_id" value="{{ request.id }}">
                                                    <button type="submit" class="btn btn-sm btn-warning" title="Notify Emergency Head">
                                                        <i class="fas fa-bell me-1"></i>Notify Emergency
                                                    </button>
                                                </form>
                                                {% elif request.status in ['notified'] %}
                                                <form method="POST" action="{{ url_for('assign_emergency_team', request_id=request.id) }}" class="d-inline">
                                                    <button type="submit" class="btn btn-sm btn-primary" title="Assign Emergency Team">
                                                        <i class="fas fa-users me-1"></i>Assign Team
                                                    </button>
                                                </form>
                                                {% elif request.status in ['assigned','completed'] %}
                                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#resolveModal{{ request.id }}" title="Mark as Resolved">
                                                    <i class="fas fa-check-circle me-1"></i>Mark Resolved
                                                </button>
                                                {% endif %}
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#requestModal{{ request.id }}" title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                            {% if request.request_count %}
                                            <span class="badge bg-secondary ms-2" title="Number of reports for this pincode">x{{ request.request_count }}</span>
                                            {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No emergency requests</h5>
                            <p class="text-muted">Requests from admin will appear here</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Team Management & Statistics -->
        <div class="col-lg-4 mb-4">
            <!-- Removed Team Assignments card (duplicate) -->

            <!-- Emergency Teams (Available only) -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-ambulance me-2"></i>Available Emergency Teams
                    </h5>
                </div>
                <div class="card-body">
                    {% if emergency_units %}
                        <div class="list-group">
                            {% for unit in emergency_units %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ unit.unit_name }}</strong>
                                    <br><small class="text-muted">{{ unit.unit_category }}</small>
                                </div>
                                <span class="badge bg-success">Available</span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-3">
                            <i class="fas fa-user-md fa-2x text-muted mb-2"></i>
                            <p class="text-muted">No emergency teams available</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>System Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Database</span>
                        <span class="badge bg-success">Online</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Emergency Teams</span>
                        <span class="badge bg-success">{{ emergency_heads|length if emergency_heads else 0 }} Available</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Active Assignments</span>
                        <span class="badge bg-warning">{{ active_assignments or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Completed Tasks</span>
                        <span class="badge bg-success">{{ completed_tasks or 0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notified Requests Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bell me-2"></i>Notified Emergency Teams (Awaiting Assignment)
                        <span class="badge bg-light text-dark ms-2">{{ notified_requests_list|length if notified_requests_list else 0 }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if notified_requests_list %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Request ID</th>
                                        <th>Incident</th>
                                        <th>Location</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in notified_requests_list %}
                                    <tr>
                                        <td><strong>#{{ request.id }}</strong></td>
                                        <td>
                                            <strong>Incident #{{ request.incident_id }}</strong>
                                            {% if request.incidents %}
                                            <br><small class="text-muted">{{ request.incidents.description[:50] }}{% if request.incidents.description|length > 50 %}...{% endif %}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ request.incidents.location if request.incidents else 'N/A' }}</strong>
                                            {% if request.incidents and request.incidents.pincode %}
                                            <br><small class="text-muted">Pincode: {{ request.incidents.pincode }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="incident-severity severity-{{ request.incidents.severity|lower if request.incidents else 'medium' }}">
                                                {{ request.incidents.severity|title if request.incidents else 'Medium' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">Notified</span>
                                        </td>
                                        <td>
                                            <form method="POST" action="{{ url_for('assign_emergency_team', request_id=request.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-sm btn-primary" title="Assign Emergency Team">
                                                    <i class="fas fa-users me-1"></i>Assign Team
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#requestModal{{ request.id }}" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-bell fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No notified requests</h5>
                            <p class="text-muted">After notifying emergency heads, requests will appear here</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Assigned Teams Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Assigned Emergency Teams
                        <span class="badge bg-light text-dark ms-2">{{ emergency_assignments|length if emergency_assignments else 0 }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if emergency_assignments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Assignment ID</th>
                                        <th>Location</th>
                                        <th>Team Lead</th>
                                        <th>Unit Assigned</th>
                                        <th>Status</th>
                                        <th>Assigned At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assignment in emergency_assignments %}
                                    <tr class="incident-card">
                                        <td><strong>#{{ assignment.id }}</strong></td>
                                        <td>
                                            <div>
                                                <strong>{{ assignment.requests.incidents.location if assignment.requests and assignment.requests.incidents else 'Emergency Location' }}</strong>
                                                {% if assignment.requests and assignment.requests.incidents and assignment.requests.incidents.pincode %}
                                                <br><small class="text-muted">Pincode: {{ assignment.requests.incidents.pincode }}</small>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ assignment.users.name if assignment.users else 'Emergency Team Lead' }}</strong>
                                                <br><small class="text-muted">{{ assignment.users.email if assignment.users else 'N/A' }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ assignment.emergency_units.unit_name if assignment.emergency_units else 'Emergency Unit' }}</strong>
                                                <br><small class="text-muted">{{ assignment.emergency_units.unit_category if assignment.emergency_units else 'Rescue' }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if assignment.status == 'Assigned' %}warning{% elif assignment.status == 'Enroute' %}info{% elif assignment.status == 'OnSite' %}primary{% elif assignment.status == 'Completed' %}success{% else %}secondary{% endif %} fs-6">
                                                {{ assignment.status or 'Assigned' }}
                                            </span>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ assignment.assigned_at[:10] if assignment.assigned_at else 'Recently' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#teamDetailsModal{{ assignment.id }}" title="View Team Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                {% if assignment.status != 'Completed' %}
                                                <form method="POST" action="{{ url_for('assign_more_teams') }}" class="d-inline">
                                                    <input type="hidden" name="assignment_id" value="{{ assignment.id }}">
                                                    <button type="submit" class="btn btn-sm btn-outline-success" title="Assign More Teams">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Emergency Teams Assigned Yet</h5>
                            <p class="text-muted">Teams will appear here once assignments are made.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Updates Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bullhorn me-2"></i>Emergency Updates from Teams
                    </h5>
                </div>
                <div class="card-body">
                    {% if emergency_updates %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Team</th>
                                        <th>Assignment</th>
                                        <th>Location</th>
                                        <th>Rescued</th>
                                        <th>Critical</th>
                                        <th>Severity</th>
                                        <th>Status</th>
                                        <th>Update Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for update in emergency_updates %}
                                    <tr>
                                        <td><strong>{{ update.team_name }}</strong></td>
                                        <td>#{{ update.assignment_id }}</td>
                                        <td>{{ update.location or 'N/A' }}</td>
                                        <td>
                                            <span class="badge bg-success">{{ update.rescued_count or 0 }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">{{ update.critical_count or 0 }}</span>
                                        </td>
                                        <td>
                                            <span class="incident-severity severity-{{ update.severity|lower if update.severity else 'medium' }}">
                                                {{ update.severity|title if update.severity else 'Medium' }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if update.assignment_status == 'completed' %}success{% elif update.assignment_status == 'in_progress' %}warning{% else %}info{% endif %}">
                                                {{ update.assignment_status|title if update.assignment_status else 'Assigned' }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <small class="text-muted">{{ update.update_time[:16] if update.update_time else 'Recently' }}</small>
                                                <form method="POST" action="{{ url_for('delete_update', update_id=update.update_id) }}" onsubmit="return confirm('Delete this update?')">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete update">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No emergency updates</h5>
                            <p class="text-muted">Updates from emergency teams will appear here</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Request Detail Modals -->
{% for request in requests %}
<div class="modal fade" id="requestModal{{ request.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Request Details #{{ request.id }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if request.incidents %}
                <div class="row">
                    <div class="col-md-6">
                        <h6>Incident Information</h6>
                        <p><strong>Incident ID:</strong> #{{ request.incident_id }}</p>
                        <p><strong>Location:</strong> {{ request.incidents.location }}</p>
                        {% if request.incidents.pincode %}
                        <p><strong>Pincode:</strong> {{ request.incidents.pincode }}</p>
                        {% endif %}
                        <p><strong>Severity:</strong> 
                            <span class="incident-severity severity-{{ request.incidents.severity|lower }}">
                                {{ request.incidents.severity|title }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Request Details</h6>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-{% if request.status == 'pending' %}warning{% elif request.status == 'accepted' %}success{% elif request.status == 'completed' %}info{% else %}danger{% endif %}">
                                {{ request.status|title }}
                            </span>
                        </p>
                        <p><strong>Received:</strong> {{ request.created_at[:16] if request.created_at else 'Recently' }}</p>
                        {% if request.accepted_at %}
                        <p><strong>Accepted:</strong> {{ request.accepted_at[:16] }}</p>
                        {% endif %}
                    </div>
                </div>
                <hr>
                <h6>Description</h6>
                <p>{{ request.incidents.description }}</p>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Incident details not available
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                {% if request.status == 'pending' %}
                <form method="POST" action="{{ url_for('accept_request', request_id=request.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-1"></i>Accept Request
                    </button>
                </form>
                <form method="POST" action="{{ url_for('notify_emergency_head') }}" class="d-inline">
                    <input type="hidden" name="request_id" value="{{ request.id }}">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-bell me-1"></i>Notify Emergency Head
                    </button>
                </form>
                {% elif request.status == 'accepted' %}
                <form method="POST" action="{{ url_for('assign_emergency_team', request_id=request.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-users me-1"></i>Assign Emergency Team
                    </button>
                </form>
                {% endif %}
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Resolve Disaster Modals -->
{% for request in requests %}
<div class="modal fade" id="resolveModal{{ request.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Mark Disaster as Resolved
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Confirm Resolution:</strong> This will mark the disaster as resolved and notify the admin to review announcements.
                </div>
                
                {% if request.incidents %}
                <div class="mb-3">
                    <h6>Incident Details:</h6>
                    <p><strong>Location:</strong> {{ request.incidents.location }}</p>
                    <p><strong>Incident ID:</strong> #{{ request.incidents.id }}</p>
                    <p><strong>Request ID:</strong> #{{ request.id }}</p>
                </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('notify_admin_resolved') }}">
                    <input type="hidden" name="request_id" value="{{ request.id }}">
                    <div class="mb-3">
                        <label for="resolution_notes{{ request.id }}" class="form-label">Resolution Notes (Optional)</label>
                        <textarea class="form-control" id="resolution_notes{{ request.id }}" name="resolution_notes" rows="3" placeholder="Add any notes about how the disaster was resolved..."></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle me-1"></i>Confirm Resolution
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Team Details Modals -->
{% for assignment in emergency_assignments %}
<div class="modal fade" id="teamDetailsModal{{ assignment.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-gradient-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-users me-2"></i>Team Assignment Details #{{ assignment.id }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Assignment Information</h6>
                        <p><strong>Assignment ID:</strong> #{{ assignment.id }}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-{% if assignment.status == 'Assigned' %}warning{% elif assignment.status == 'Enroute' %}info{% elif assignment.status == 'OnSite' %}primary{% elif assignment.status == 'Completed' %}success{% else %}secondary{% endif %}">
                                {{ assignment.status or 'Assigned' }}
                            </span>
                        </p>
                        <p><strong>Assigned At:</strong> {{ assignment.assigned_at or 'Recently' }}</p>
                        {% if assignment.completed_at %}
                        <p><strong>Completed At:</strong> {{ assignment.completed_at }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Team Information</h6>
                        <p><strong>Team Lead:</strong> {{ assignment.users.name if assignment.users else 'Emergency Team Lead' }}</p>
                        <p><strong>Email:</strong> {{ assignment.users.email if assignment.users else 'N/A' }}</p>
                        <p><strong>Unit Name:</strong> {{ assignment.emergency_units.unit_name if assignment.emergency_units else 'Emergency Unit' }}</p>
                        <p><strong>Unit Category:</strong> {{ assignment.emergency_units.unit_category if assignment.emergency_units else 'Rescue' }}</p>
                    </div>
                </div>
                {% if assignment.requests and assignment.requests.incidents %}
                <hr>
                <h6>Incident Details</h6>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Location:</strong> {{ assignment.requests.incidents.location }}</p>
                        <p><strong>Pincode:</strong> {{ assignment.requests.incidents.pincode or 'Not specified' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>City:</strong> {{ assignment.requests.incidents.city or 'Not specified' }}</p>
                        <p><strong>State:</strong> {{ assignment.requests.incidents.state or 'Not specified' }}</p>
                    </div>
                </div>
                <p><strong>Description:</strong> {{ assignment.requests.incidents.description }}</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Assign More Teams Modal -->
<div class="modal fade" id="assignMoreTeamsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-gradient-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Assign Additional Teams
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('assign_more_teams') }}">
                    <input type="hidden" name="assignment_id" id="more_teams_assignment_id">
                    <div class="mb-3">
                        <label for="additional_units" class="form-label">Select Additional Units</label>
                        <select class="form-select" id="additional_units" name="unit_ids" multiple required>
                            {% for unit in emergency_units %}
                            {% if unit.status == 'Free' %}
                            <option value="{{ unit.id }}">{{ unit.unit_name }} ({{ unit.unit_category }}) - {{ unit.users.name if unit.users else 'Available' }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple units</div>
                    </div>
                    <div class="mb-3">
                        <label for="additional_notes" class="form-label">Additional Instructions</label>
                        <textarea class="form-control" id="additional_notes" name="notes" rows="3" placeholder="Any specific instructions for the additional teams..."></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i>Assign Additional Teams
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Handle assign more teams button clicks
document.addEventListener('DOMContentLoaded', function() {
    const assignMoreButtons = document.querySelectorAll('button[title="Assign More Teams"]');
    assignMoreButtons.forEach(button => {
        button.addEventListener('click', function() {
            const assignmentId = this.closest('form').querySelector('input[name="assignment_id"]').value;
            document.getElementById('more_teams_assignment_id').value = assignmentId;
        });
    });
});
</script>

{% endblock %}